# Devstation Host Environment

You are running on a headless Ubuntu/Debian server configured by devstation-setup.

## CRITICAL: You Are on the HOST, Not Inside a Container

This CLAUDE.md is at ~/CLAUDE.md on the HOST machine. Repos are in ~/code/ but their devcontainers run in Docker. To work on code:

1. **Start the container**: `~/devcontainer-rebuild.sh ~/code/REPO_NAME`
2. **Enter the container**: `dexec ~/code/REPO_NAME` or `dexec-REPO_NAME`
3. **Run Claude inside**: Once in the container, run `claude` there

DO NOT edit code in ~/code/* directly from the host - always enter the devcontainer first.

## Directory Structure

```
~/                          # You are here (host home)
├── CLAUDE.md               # This file (host-only context)
├── devstation-setup/       # Bootstrap scripts and templates
│   ├── bootstrap.sh        # Phase 1: Install dependencies
│   ├── install.sh          # Phase 2: Clone repos interactively
│   ├── scripts/            # Helper scripts (symlinked to ~/)
│   └── templates/          # Devcontainer templates (node, python, dotnet)
├── code/                   # Cloned repositories
│   ├── repo-a/             # Each repo has .devcontainer/
│   ├── repo-b/
│   └── ...
├── devcontainer-rebuild.sh # Symlink -> devstation-setup/scripts/
├── devcontainer-open.sh    # Symlink
├── devcontainer-stop-all.sh
├── devcontainer-cleanup.sh
└── dexec                   # Symlink - exec into containers
```

## Devcontainer Commands (Run from Host)

| Command | Purpose |
|---------|---------|
| `~/devcontainer-rebuild.sh ~/code/REPO` | Build and start container |
| `~/devcontainer-rebuild.sh ~/code` | Rebuild ALL repos in ~/code |
| `~/devcontainer-open.sh ~/code/REPO` | Start stopped container |
| `~/devcontainer-stop-all.sh` | Stop all devcontainers |
| `~/devcontainer-cleanup.sh` | Remove stopped containers, prune images |
| `dexec ~/code/REPO` | Shell into running container |
| `dexec-REPONAME` | Alias for dexec (generated by install.sh) |

## Container Lifecycle

```
Host: ~/code/my-repo/          Container: /workspaces/my-repo/
        │                                      │
        │ devcontainer up                      │
        ├─────────────────────────────────────►│
        │ (bind-mount)                         │
        │                                      │
        │ dexec ~/code/my-repo                 │
        ├─────────────────────────────────────►│ bash shell
        │                                      │ (work here!)
```

## Setting Up a New Repo

1. Clone: `cd ~/code && git clone URL`
2. Add devcontainer config:
   - Copy template: `cp -r ~/devstation-setup/templates/node/.devcontainer ~/code/REPO/`
   - Or use existing .devcontainer in the repo
3. Build: `~/devcontainer-rebuild.sh ~/code/REPO`
4. Enter: `dexec ~/code/REPO`

## Template Options

| Template | Base | Features |
|----------|------|----------|
| `templates/node/` | node:20-bookworm | npm cache volume, port 3000 |
| `templates/python/` | python:3.12-bookworm | pip cache volume, port 8000 |
| `templates/dotnet/` | dotnet/sdk:9.0 | PostgreSQL, npm+nuget caches, ports 5000,5432 |

## Common Host Tasks

**Re-run repo discovery:** `~/devstation-setup/install.sh`
**Check running containers:** `docker ps`
**View container logs:** `docker logs CONTAINER_ID`
**Clean up Docker:** `docker system prune -af`
**Rebuild all containers:** `~/devcontainer-rebuild.sh ~/code --force`

## Claude Code Authentication

All containers share auth and settings via bind-mounting `~/.claude/` from the host:

```
Host ~/.claude/ ←bind-mount→ Container ~/.claude/
```

- **Credentials**: `.credentials.json` (OAuth tokens) — shared across all containers
- **Settings**: `settings.json` (statusline, plugins) — shared, changes propagate instantly
- **Onboarding**: `~/.claude.json` with `hasCompletedOnboarding` is baked into the base Docker image (`devstation-base:latest`), so no bind mount needed for that file

### Setup
1. Authenticate once on the host: run `claude` and complete login
2. All containers automatically pick up credentials via the bind mount
3. No env vars needed (`ANTHROPIC_API_KEY` or `CLAUDE_CODE_OAUTH_TOKEN` trigger API billing mode)

### devcontainer.json mount (in every repo):
```json
"--mount", "type=bind,source=${localEnv:HOME}/.claude,target=/home/vscode/.claude",
```

### initializeCommand must include:
```bash
mkdir -p "$HOME/.claude"
```

## Inside Containers

Once you `dexec` into a container:
- Working directory: `/workspaces/REPO_NAME`
- User: `vscode` (has sudo)
- Tools: git, gh, node/python/dotnet (per template), gitui
- The container has its own CLAUDE.md (if the repo has one)
- API keys: Set in `~/code/REPO/.devcontainer/.env` (git-ignored)

## Troubleshooting

### Docker-in-Docker fails on Debian trixie

If a devcontainer build fails with:
```
The 'moby' option is not supported on Debian 'trixie' because 'moby-cli'
and related system packages have been removed from that distribution.
```

**Fix:** In the repo's `.devcontainer/devcontainer.json`, set `"moby": false`:
```json
"features": {
    "ghcr.io/devcontainers/features/docker-in-docker:2": {
        "moby": false
    }
}
```

This switches from moby packages to official Docker packages.
